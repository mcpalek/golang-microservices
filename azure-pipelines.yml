trigger:
  branches:
    include:
      - main

stages:
- stage: Build
  jobs:
  - job: Build
    steps:
    # Build and push db_service
    - task: Docker@2
      inputs:
        command: buildAndPush
        containerRegistry: 'MyAzureContainerRegistry'
        repository: 'db_service'
        dockerfile: 'db_service/Dockerfile'
        buildContext: $(Build.SourcesDirectory)
        tags: latest

    # Build and push web_service
    - task: Docker@2
      inputs:
        command: buildAndPush
        containerRegistry: 'MyAzureContainerRegistry'
        repository: 'web_service'
        dockerfile: 'web_service/Dockerfile'
        buildContext: $(Build.SourcesDirectory)
        tags: latest

    # Build and push frontend_service
    - task: Docker@2
      inputs:
        command: buildAndPush
        containerRegistry: 'MyAzureContainerRegistry'
        repository: 'frontend_service'
        dockerfile: 'frontend_service/Dockerfile'
        buildContext: $(Build.SourcesDirectory)
        tags: latest

- stage: Deploy
  jobs:
  - job: Deploy
    steps:
    # ✅ Download kubeconfig.yaml file
    - task: DownloadSecureFile@1
      inputs:
        secureFile: 'kubeconfig.yaml'

    # ✅ Debugging step: Ensure kubeconfig is downloaded and accessible
    - script: |
        ls -lah $(Agent.TempDirectory)
        cat $(Agent.TempDirectory)/kubeconfig.yaml
      displayName: 'Debug: Check kubeconfig file'

    # ✅ Verify the pipeline user
    - script: whoami
      displayName: 'Check Pipeline User'

    # ✅ Set Kubeconfig and test cluster access
    - script: |
        chmod 600 $(Agent.TempDirectory)/kubeconfig.yaml
        export KUBECONFIG=$(Agent.TempDirectory)/kubeconfig.yaml
        kubectl config view
        kubectl get nodes
      displayName: 'Set Kubeconfig and Verify Cluster Access'

    # ✅ Check network connectivity to Kubernetes API
    - script: |
        echo "Pinging Kubernetes API Server..."
        ping -c 4 192.168.100.202 || echo "Ping failed!"

        echo "Checking if API server port 6443 is open..."
        nc -zv 192.168.100.202 6443 || echo "Port check failed (nc)"

        echo "Checking API server with telnet..."
        (echo quit | telnet 192.168.100.202 6443) || echo "Telnet failed!"

      displayName: 'Network Connectivity Check'

    # ✅ Check Kubernetes API access
    - script: |
        echo "Checking Kubernetes API with curl..."
        curl --max-time 20 -v -k https://192.168.100.202:6443 || echo "API check failed!"

      displayName: 'Check Kubernetes API Access'

    # ✅ Debug Kubernetes API failures
    - script: |
        export KUBECONFIG=$(Agent.TempDirectory)/kubeconfig.yaml
        echo "Checking Kubernetes cluster info..."
        kubectl cluster-info || echo "Cluster info unavailable!"

        echo "Fetching logs if API is unreachable..."
        if ! kubectl cluster-info; then
          echo "Retrieving recent logs from master node..."
          ssh -o StrictHostKeyChecking=no user@192.168.100.202 'sudo journalctl -u kube-apiserver --no-pager | tail -n 50' || echo "SSH log fetch failed!"
        fi
      displayName: 'Debug Kubernetes API'

    # ✅ Deploy Kubernetes manifests
    - script: |
        export KUBECONFIG=$(Agent.TempDirectory)/kubeconfig.yaml
        kubectl apply -f k8s/
      displayName: 'Apply Kubernetes Manifests'

    # ✅ Use Kubernetes Task to deploy with the correct kubeconfig
    - task: Kubernetes@1
      inputs:
        connectionType: 'KubeConfig'
        kubeconfig: '$(Agent.TempDirectory)/kubeconfig.yaml'
        command: 'apply'
        arguments: '-f k8s/'
      displayName: 'Deploy using Kubernetes Task'
# - stage: Deploy
#   jobs:
#   - job: Deploy
#     steps:
#     - task: DownloadSecureFile@1
#       inputs:
#         secureFile: 'kubeconfig.yaml'

#     - script: |
#         chmod 600 $(Agent.TempDirectory)/kubeconfig.yaml
#         export KUBECONFIG=$(Agent.TempDirectory)/kubeconfig.yaml
#         kubectl config view
#         kubectl get nodes
#       displayName: 'Set Kubeconfig and Verify Cluster Access'

#     - script: |
#         export KUBECONFIG=$(Agent.TempDirectory)/kubeconfig.yaml
#         kubectl apply -f k8s/
#       displayName: 'Apply Kubernetes Manifests'

